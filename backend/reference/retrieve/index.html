
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../main/">
      
      
        <link rel="next" href="../tests/fixtures/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.36">
    
    
      
        <title>Retrieve - TalkingCode</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.06209087.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#backend.retrieval_augmented_generation.retrieve" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="TalkingCode" class="md-header__button md-logo" aria-label="TalkingCode" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TalkingCode
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Retrieve
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="TalkingCode" class="md-nav__button md-logo" aria-label="TalkingCode" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TalkingCode
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Backend
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Backend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../endpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Errors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../foo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Foo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../main/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Main
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Retrieve
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Retrieve
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve" class="md-nav__link">
    <span class="md-ellipsis">
      retrieve
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" class="md-nav__link">
    <span class="md-ellipsis">
      EmbeddedResponse
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService" class="md-nav__link">
    <span class="md-ellipsis">
      EmbeddingService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EmbeddingService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService.embed" class="md-nav__link">
    <span class="md-ellipsis">
      embed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService.get_embed_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_embed_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.GenerationService" class="md-nav__link">
    <span class="md-ellipsis">
      GenerationService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenerationService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.GenerationService.augmented_generation" class="md-nav__link">
    <span class="md-ellipsis">
      augmented_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.GenerationService.get_chat_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_chat_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.InputQuery" class="md-nav__link">
    <span class="md-ellipsis">
      InputQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InputQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.InputQuery.previous_context_to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      previous_context_to_dict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAIEmbeddingService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAIEmbeddingService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService.embed" class="md-nav__link">
    <span class="md-ellipsis">
      embed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService.get_embed_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_embed_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAIGenerationService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAIGenerationService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService.augmented_generation" class="md-nav__link">
    <span class="md-ellipsis">
      augmented_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService.get_chat_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_chat_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.PreviousQAs" class="md-nav__link">
    <span class="md-ellipsis">
      PreviousQAs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RAGResponse" class="md-nav__link">
    <span class="md-ellipsis">
      RAGResponse
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RemainingSpend" class="md-nav__link">
    <span class="md-ellipsis">
      RemainingSpend
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration" class="md-nav__link">
    <span class="md-ellipsis">
      RetrievalAugmentedGeneration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetrievalAugmentedGeneration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration.remaining_spend" class="md-nav__link">
    <span class="md-ellipsis">
      remaining_spend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration.retrieval_augmented_generation" class="md-nav__link">
    <span class="md-ellipsis">
      retrieval_augmented_generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService" class="md-nav__link">
    <span class="md-ellipsis">
      RetrievalService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetrievalService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.get_current_spend" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_spend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.retrieve_top_k" class="md-nav__link">
    <span class="md-ellipsis">
      retrieve_top_k
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.store_token_spent" class="md-nav__link">
    <span class="md-ellipsis">
      store_token_spent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.validate_session_id" class="md-nav__link">
    <span class="md-ellipsis">
      validate_session_id
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext" class="md-nav__link">
    <span class="md-ellipsis">
      RetrievedContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetrievedContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext.from_document" class="md-nav__link">
    <span class="md-ellipsis">
      from_document
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext.to_context" class="md-nav__link">
    <span class="md-ellipsis">
      to_context
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService" class="md-nav__link">
    <span class="md-ellipsis">
      SQLRetrievalService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQLRetrievalService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.get_current_spend" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_spend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.retrieve_top_k" class="md-nav__link">
    <span class="md-ellipsis">
      retrieve_top_k
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.store_token_spent" class="md-nav__link">
    <span class="md-ellipsis">
      store_token_spent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.validate_session_id" class="md-nav__link">
    <span class="md-ellipsis">
      validate_session_id
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.add_sources" class="md-nav__link">
    <span class="md-ellipsis">
      add_sources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_6" >
        
          
          <label class="md-nav__link" for="__nav_2_5_6" id="__nav_2_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tests
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_6">
            <span class="md-nav__icon md-icon"></span>
            Tests
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tests/fixtures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fixtures
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Frontend
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Frontend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../frontend/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pipelines
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Pipelines
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipelines/Overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipelines/reference/assets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Assets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipelines/reference/embedding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Embedding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipelines/reference/ingestion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ingestion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipelines/reference/resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resources
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve" class="md-nav__link">
    <span class="md-ellipsis">
      retrieve
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" class="md-nav__link">
    <span class="md-ellipsis">
      EmbeddedResponse
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService" class="md-nav__link">
    <span class="md-ellipsis">
      EmbeddingService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EmbeddingService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService.embed" class="md-nav__link">
    <span class="md-ellipsis">
      embed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService.get_embed_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_embed_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.GenerationService" class="md-nav__link">
    <span class="md-ellipsis">
      GenerationService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenerationService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.GenerationService.augmented_generation" class="md-nav__link">
    <span class="md-ellipsis">
      augmented_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.GenerationService.get_chat_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_chat_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.InputQuery" class="md-nav__link">
    <span class="md-ellipsis">
      InputQuery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InputQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.InputQuery.previous_context_to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      previous_context_to_dict
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAIEmbeddingService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAIEmbeddingService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService.embed" class="md-nav__link">
    <span class="md-ellipsis">
      embed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService.get_embed_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_embed_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAIGenerationService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OpenAIGenerationService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService.augmented_generation" class="md-nav__link">
    <span class="md-ellipsis">
      augmented_generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService.get_chat_model_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_chat_model_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.PreviousQAs" class="md-nav__link">
    <span class="md-ellipsis">
      PreviousQAs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RAGResponse" class="md-nav__link">
    <span class="md-ellipsis">
      RAGResponse
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RemainingSpend" class="md-nav__link">
    <span class="md-ellipsis">
      RemainingSpend
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration" class="md-nav__link">
    <span class="md-ellipsis">
      RetrievalAugmentedGeneration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetrievalAugmentedGeneration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration.remaining_spend" class="md-nav__link">
    <span class="md-ellipsis">
      remaining_spend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration.retrieval_augmented_generation" class="md-nav__link">
    <span class="md-ellipsis">
      retrieval_augmented_generation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService" class="md-nav__link">
    <span class="md-ellipsis">
      RetrievalService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetrievalService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.get_current_spend" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_spend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.retrieve_top_k" class="md-nav__link">
    <span class="md-ellipsis">
      retrieve_top_k
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.store_token_spent" class="md-nav__link">
    <span class="md-ellipsis">
      store_token_spent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievalService.validate_session_id" class="md-nav__link">
    <span class="md-ellipsis">
      validate_session_id
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext" class="md-nav__link">
    <span class="md-ellipsis">
      RetrievedContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetrievedContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext.from_document" class="md-nav__link">
    <span class="md-ellipsis">
      from_document
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext.to_context" class="md-nav__link">
    <span class="md-ellipsis">
      to_context
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService" class="md-nav__link">
    <span class="md-ellipsis">
      SQLRetrievalService
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQLRetrievalService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.get_current_spend" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_spend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.retrieve_top_k" class="md-nav__link">
    <span class="md-ellipsis">
      retrieve_top_k
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.store_token_spent" class="md-nav__link">
    <span class="md-ellipsis">
      store_token_spent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.validate_session_id" class="md-nav__link">
    <span class="md-ellipsis">
      validate_session_id
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend.retrieval_augmented_generation.retrieve.add_sources" class="md-nav__link">
    <span class="md-ellipsis">
      add_sources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Retrieve</h1>

<div class="doc doc-object doc-module">



<a id="backend.retrieval_augmented_generation.retrieve"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" class="doc doc-heading">
            <code>EmbeddedResponse</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>A class that represents the embedded response. This class is used to represent the response
generated by the embedding service. The embedded response contains the embedding and the number
of tokens spent on the embedding. This data class is used to pass the embedded response between
the <code>EmbeddingService</code> and the <code>RetrievalService</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>embedding</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedded query.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>token_count</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of tokens spent on the embedding.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EmbeddedResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that represents the embedded response. This class is used to represent the response</span>
<span class="sd">    generated by the embedding service. The embedded response contains the embedding and the number</span>
<span class="sd">    of tokens spent on the embedding. This data class is used to pass the embedded response between</span>
<span class="sd">    the `EmbeddingService` and the `RetrievalService`.</span>

<span class="sd">    Args:</span>
<span class="sd">        embedding (list[float]): The embedded query.</span>
<span class="sd">        token_count (int): The number of tokens spent on the embedding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">embedding</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.EmbeddingService" class="doc doc-heading">
            <code>EmbeddingService</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" title="typing.Protocol" href="https://docs.python.org/3/library/typing.html#typing.Protocol">Protocol</a></code></p>


        <p>The interface for the embedding service. Responsible for embedding the input query.
The embedded query is then used to retrieve the top k contexts based on the
embedded query by the <code>RetrievalService</code>.</p>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EmbeddingService</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The interface for the embedding service. Responsible for embedding the input query.</span>
<span class="sd">    The embedded query is then used to retrieve the top k contexts based on the</span>
<span class="sd">    embedded query by the `RetrievalService`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EmbeddedResponse&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Embeds the input text. Turns the input text into a list of floats that represent the text.</span>
<span class="sd">        The embedded response also contains the number of tokens spent on the embedding.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The text to embed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (EmbeddedResponse): The embedded response. Contains the embedding and the number of tokens spent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get_embed_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the name of the embedding model used for embedding. Needed for tracking the token spend</span>
<span class="sd">        per model. Each model has a different token cost, e.g., the embedding model is typically cheaper</span>
<span class="sd">        than the generation model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): The name of the embedding model used for embedding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.EmbeddingService.embed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">embed</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Embeds the input text. Turns the input text into a list of floats that represent the text.
The embedded response also contains the number of tokens spent on the embedding.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>text</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text to embed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" href="#backend.retrieval_augmented_generation.retrieve.EmbeddedResponse">EmbeddedResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedded response. Contains the embedding and the number of tokens spent.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EmbeddedResponse&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embeds the input text. Turns the input text into a list of floats that represent the text.</span>
<span class="sd">    The embedded response also contains the number of tokens spent on the embedding.</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str): The text to embed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (EmbeddedResponse): The embedded response. Contains the embedding and the number of tokens spent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.EmbeddingService.get_embed_model_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_embed_model_name</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the name of the embedding model used for embedding. Needed for tracking the token spend
per model. Each model has a different token cost, e.g., the embedding model is typically cheaper
than the generation model.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the embedding model used for embedding.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_embed_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the name of the embedding model used for embedding. Needed for tracking the token spend</span>
<span class="sd">    per model. Each model has a different token cost, e.g., the embedding model is typically cheaper</span>
<span class="sd">    than the generation model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): The name of the embedding model used for embedding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.GenerationService" class="doc doc-heading">
            <code>GenerationService</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" title="typing.Protocol" href="https://docs.python.org/3/library/typing.html#typing.Protocol">Protocol</a></code></p>


        <p>The interface for the generation service. Responsible for generating the response
given the input query and the retrieved contexts.</p>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">GenerationService</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The interface for the generation service. Responsible for generating the response</span>
<span class="sd">    given the input query and the retrieved contexts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">augmented_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;InputQuery&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;RetrievedContext&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Answers the user&#39;s query with the retrieved context.</span>
<span class="sd">        Requires that you already have the context retrieved from the `RetrievalService`.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">                the previous context and session ID.</span>
<span class="sd">            context (list[RetrievedContext]): The list of retrieved contexts. Each one contains</span>
<span class="sd">                the distance, file name, repository name, path in the repository, extension, and URL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple[str, int]): The response generated by the model and the number of tokens spent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get_chat_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the name of the chat model used for generation. Needed for tracking the token spend</span>
<span class="sd">           per model. Each model has a different token cost, e.g., the embedding model is typically cheaper</span>
<span class="sd">           than the generation model.</span>


<span class="sd">        Returns:</span>
<span class="sd">            (str): The name of the chat model used for generation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.GenerationService.augmented_generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">augmented_generation</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Answers the user's query with the retrieved context.
Requires that you already have the context retrieved from the <code>RetrievalService</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>query</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.InputQuery" href="#backend.retrieval_augmented_generation.retrieve.InputQuery">InputQuery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input query. Contains the user's question, and optionally,
the previous context and session ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievedContext" href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext">RetrievedContext</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of retrieved contexts. Each one contains
the distance, file name, repository name, path in the repository, extension, and URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The response generated by the model and the number of tokens spent.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">augmented_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;InputQuery&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;RetrievedContext&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Answers the user&#39;s query with the retrieved context.</span>
<span class="sd">    Requires that you already have the context retrieved from the `RetrievalService`.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">            the previous context and session ID.</span>
<span class="sd">        context (list[RetrievedContext]): The list of retrieved contexts. Each one contains</span>
<span class="sd">            the distance, file name, repository name, path in the repository, extension, and URL.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple[str, int]): The response generated by the model and the number of tokens spent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.GenerationService.get_chat_model_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_chat_model_name</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the name of the chat model used for generation. Needed for tracking the token spend
   per model. Each model has a different token cost, e.g., the embedding model is typically cheaper
   than the generation model.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the chat model used for generation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_chat_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the name of the chat model used for generation. Needed for tracking the token spend</span>
<span class="sd">       per model. Each model has a different token cost, e.g., the embedding model is typically cheaper</span>
<span class="sd">       than the generation model.</span>


<span class="sd">    Returns:</span>
<span class="sd">        (str): The name of the chat model used for generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.InputQuery" class="doc doc-heading">
            <code>InputQuery</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>A Pydantic model for the input query. This class is client facing and is used to validate the input query.
The first question in the conversation will not have any previous context and will not have a session ID.
The subsequent questions will have a session ID and previous context. The previous context is a list of
question-answer pairs from the previous interactions. The session ID is used to track the token spend for
the given session.</p>
<p>If the session ID is provided, the previous context must also be provided otherwise a <code>ValueError</code> is raised.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/exceptions.html#ValueError">ValueError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the session ID is provided but the previous context is not provided or vice versa.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">InputQuery</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Pydantic model for the input query. This class is client facing and is used to validate the input query.</span>
<span class="sd">    The first question in the conversation will not have any previous context and will not have a session ID.</span>
<span class="sd">    The subsequent questions will have a session ID and previous context. The previous context is a list of</span>
<span class="sd">    question-answer pairs from the previous interactions. The session ID is used to track the token spend for</span>
<span class="sd">    the given session.</span>

<span class="sd">    If the session ID is provided, the previous context must also be provided otherwise a `ValueError` is raised.</span>

<span class="sd">    Raises:</span>
<span class="sd">        (ValueError): If the session ID is provided but the previous context is not provided or vice versa.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">previous_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">PreviousQAs</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">previous_context_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the previous context from a list of `PreviousQAs` to a list of dictionaries.</span>
<span class="sd">        This is the exact format that OpenAI&#39;s SDK expects for its completion API.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict[str, str]]: The previous context as a list of dictionaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_context</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_context</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">qa</span><span class="o">.</span><span class="n">question</span><span class="p">})</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">qa</span><span class="o">.</span><span class="n">answer</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_validate_previous_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the input query. Ensures that the session ID is provided if the previous context is provided</span>
<span class="sd">        and vice versa.</span>

<span class="sd">        Raises:</span>
<span class="sd">            (ValueError): If the session ID is provided but the previous context is not provided or vice versa.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_context</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Previous context must be provided if session_id is present.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_context</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Session ID must be provided if previous context is present.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.InputQuery.previous_context_to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">previous_context_to_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Transforms the previous context from a list of <code>PreviousQAs</code> to a list of dictionaries.
This is the exact format that OpenAI's SDK expects for its completion API.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[dict[str, str]]: The previous context as a list of dictionaries.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">previous_context_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms the previous context from a list of `PreviousQAs` to a list of dictionaries.</span>
<span class="sd">    This is the exact format that OpenAI&#39;s SDK expects for its completion API.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[dict[str, str]]: The previous context as a list of dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_context</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">qa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_context</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">qa</span><span class="o">.</span><span class="n">question</span><span class="p">})</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">qa</span><span class="o">.</span><span class="n">answer</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService" class="doc doc-heading">
            <code>OpenAIEmbeddingService</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.EmbeddingService" href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService">EmbeddingService</a></code></p>


        <p>A class that performs text embedding using OpenAI's API. The class is responsible for embedding
the input text. The embedded text is then used to retrieve the top k contexts based on the embedded
query by the <code>RetrievalService</code>. The class is a wrapper around OpenAI's SDK and provides a more
testable and maintainable interface. It implements the <code>EmbeddingService</code> interface.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>client</code></td>
            <td>
                  <code><span title="openai.AsyncOpenAI">AsyncOpenAI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The OpenAI client used for text embedding.
Relies on the <code>OPENAI_EMBEDDING_API_KEY</code> environment variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>embedding_model</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the embedding model used for text embedding.
In practice this is <code>text-embedding-3-large</code> but it is configurable through environment variables.
It can directly be set with the <code>EMBEDDING_MODEL</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OpenAIEmbeddingService</span><span class="p">(</span><span class="n">EmbeddingService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that performs text embedding using OpenAI&#39;s API. The class is responsible for embedding</span>
<span class="sd">    the input text. The embedded text is then used to retrieve the top k contexts based on the embedded</span>
<span class="sd">    query by the `RetrievalService`. The class is a wrapper around OpenAI&#39;s SDK and provides a more</span>
<span class="sd">    testable and maintainable interface. It implements the `EmbeddingService` interface.</span>

<span class="sd">    Args:</span>
<span class="sd">        client (AsyncOpenAI): The OpenAI client used for text embedding.</span>
<span class="sd">            Relies on the `OPENAI_EMBEDDING_API_KEY` environment variable.</span>
<span class="sd">        embedding_model (str): The name of the embedding model used for text embedding.</span>
<span class="sd">            In practice this is `text-embedding-3-large` but it is configurable through environment variables.</span>
<span class="sd">            It can directly be set with the `EMBEDDING_MODEL`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span>
    <span class="n">embedding_model</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmbeddedResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Embeds the input text. Turns the input text into a list of floats that represent the text.</span>
<span class="sd">        The embedded response also contains the number of tokens spent on the embedding.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The text to embed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            EmbeddedResponse: The embedded response. Contains the embedding and the number of tokens spent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">EmbeddedResponse</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">token_count</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">total_tokens</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_embed_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper around the `embedding_model` attribute. Necessary to conform to the `EmbeddingService` interface.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of the embedding model used for embedding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService.embed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">embed</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Embeds the input text. Turns the input text into a list of floats that represent the text.
The embedded response also contains the number of tokens spent on the embedding.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>text</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text to embed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>EmbeddedResponse</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" href="#backend.retrieval_augmented_generation.retrieve.EmbeddedResponse">EmbeddedResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedded response. Contains the embedding and the number of tokens spent.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmbeddedResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embeds the input text. Turns the input text into a list of floats that represent the text.</span>
<span class="sd">    The embedded response also contains the number of tokens spent on the embedding.</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str): The text to embed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        EmbeddedResponse: The embedded response. Contains the embedding and the number of tokens spent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="n">text</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">EmbeddedResponse</span><span class="p">(</span>
        <span class="n">embedding</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
        <span class="n">token_count</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">total_tokens</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.OpenAIEmbeddingService.get_embed_model_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_embed_model_name</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Wrapper around the <code>embedding_model</code> attribute. Necessary to conform to the <code>EmbeddingService</code> interface.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the embedding model used for embedding.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_embed_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper around the `embedding_model` attribute. Necessary to conform to the `EmbeddingService` interface.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The name of the embedding model used for embedding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService" class="doc doc-heading">
            <code>OpenAIGenerationService</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.GenerationService" href="#backend.retrieval_augmented_generation.retrieve.GenerationService">GenerationService</a></code></p>


        <p>A class that performs text generation using OpenAI's API. The class is responsible for generating
the response given the input query and the retrieved contexts. The class is a wrapper around OpenAI's
SDK and provides a more testable and maintainable interface. It implements the <code>GenerationService</code> interface.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>client</code></td>
            <td>
                  <code><span title="openai.AsyncOpenAI">AsyncOpenAI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The OpenAI client used for text generation.
Relies on the <code>OPENAI_EMBEDDING_API_KEY</code> environment variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>chat_model</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the chat model used for text generation.
Can be set with the <code>CHAT_MODEL</code> environment variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>system_prompt</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The system prompt used for text generation.
Can be set with the <code>SYSTEM_PROMPT</code> environment variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OpenAIGenerationService</span><span class="p">(</span><span class="n">GenerationService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that performs text generation using OpenAI&#39;s API. The class is responsible for generating</span>
<span class="sd">    the response given the input query and the retrieved contexts. The class is a wrapper around OpenAI&#39;s</span>
<span class="sd">    SDK and provides a more testable and maintainable interface. It implements the `GenerationService` interface.</span>

<span class="sd">    Args:</span>
<span class="sd">        client (AsyncOpenAI): The OpenAI client used for text generation.</span>
<span class="sd">            Relies on the `OPENAI_EMBEDDING_API_KEY` environment variable.</span>
<span class="sd">        chat_model (str): The name of the chat model used for text generation.</span>
<span class="sd">            Can be set with the `CHAT_MODEL` environment variable.</span>
<span class="sd">        system_prompt (str): The system prompt used for text generation.</span>
<span class="sd">            Can be set with the `SYSTEM_PROMPT` environment variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span><span class="p">:</span> <span class="n">AsyncOpenAI</span>
    <span class="n">chat_model</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">augmented_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">InputQuery</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RetrievedContext</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Answers the user&#39;s query with the retrieved context. Requires that you already have the context</span>
<span class="sd">        retrieved from the `RetrievalService`.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">                the previous context and session ID.</span>
<span class="sd">            context (list[RetrievedContext]): The list of retrieved contexts. Each one contains</span>
<span class="sd">                the distance, file name, repository name, path in the repository, extension, and URL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple[str, int]): The response generated by the model and the number of tokens spent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">to_context</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context</span><span class="p">])</span>
        <span class="n">model_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model_input</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chat_model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">model_input</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">total_tokens</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">add_sources</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">get_chat_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the name of the chat model used for generation. Needed for tracking the token spend</span>
<span class="sd">            per model. Each model has a different token cost, e.g., the embedding model is typically cheaper</span>
<span class="sd">            than the generation model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): The name of the chat model used for generation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_model</span>

    <span class="k">def</span> <span class="nf">_create_model_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">InputQuery</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates the model input for the generation API. The model input is a list of dictionaries.&quot;&quot;&quot;</span>
        <span class="n">query_with_ctx</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The user&#39;s question is </span><span class="si">{</span><span class="nb">input</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">        You have access to additional context in a list of code files: </span><span class="si">{</span><span class="n">ctx</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="n">previous_qas</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">previous_context_to_dict</span><span class="p">()</span>

        <span class="n">model_input</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span>
        <span class="n">model_input</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">previous_qas</span><span class="p">)</span>
        <span class="n">model_input</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">query_with_ctx</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">model_input</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService.augmented_generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">augmented_generation</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Answers the user's query with the retrieved context. Requires that you already have the context
retrieved from the <code>RetrievalService</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>query</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.InputQuery" href="#backend.retrieval_augmented_generation.retrieve.InputQuery">InputQuery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input query. Contains the user's question, and optionally,
the previous context and session ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>context</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievedContext" href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext">RetrievedContext</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of retrieved contexts. Each one contains
the distance, file name, repository name, path in the repository, extension, and URL.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#tuple">tuple</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The response generated by the model and the number of tokens spent.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">augmented_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">InputQuery</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RetrievedContext</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Answers the user&#39;s query with the retrieved context. Requires that you already have the context</span>
<span class="sd">    retrieved from the `RetrievalService`.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">            the previous context and session ID.</span>
<span class="sd">        context (list[RetrievedContext]): The list of retrieved contexts. Each one contains</span>
<span class="sd">            the distance, file name, repository name, path in the repository, extension, and URL.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple[str, int]): The response generated by the model and the number of tokens spent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">to_context</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context</span><span class="p">])</span>
    <span class="n">model_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model_input</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chat_model</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">model_input</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">total_tokens</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">add_sources</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">tokens</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.OpenAIGenerationService.get_chat_model_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_chat_model_name</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the name of the chat model used for generation. Needed for tracking the token spend
    per model. Each model has a different token cost, e.g., the embedding model is typically cheaper
    than the generation model.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the chat model used for generation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_chat_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the name of the chat model used for generation. Needed for tracking the token spend</span>
<span class="sd">        per model. Each model has a different token cost, e.g., the embedding model is typically cheaper</span>
<span class="sd">        than the generation model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): The name of the chat model used for generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.PreviousQAs" class="doc doc-heading">
            <code>PreviousQAs</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>A Pydantic model for the previous question-answer pairs. This is used to provide the model with
additional context from previous interactions. It is a pydantic model because it is client
facing and is used to validate the input query. This model is used in the <code>InputQuery</code> model.</p>


<details class="fields" open>
  <summary>Fields</summary>
  <p>question (str): A previously asked question asked by the user.
answer (str): A previously received answer provided by the assistant.</p>
</details>
              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PreviousQAs</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Pydantic model for the previous question-answer pairs. This is used to provide the model with</span>
<span class="sd">    additional context from previous interactions. It is a pydantic model because it is client</span>
<span class="sd">    facing and is used to validate the input query. This model is used in the `InputQuery` model.</span>

<span class="sd">    Fields:</span>
<span class="sd">        question (str): A previously asked question asked by the user.</span>
<span class="sd">        answer (str): A previously received answer provided by the assistant.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.RAGResponse" class="doc doc-heading">
            <code>RAGResponse</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>A class that represents the response generated by the model and the session ID.
This data class is client facing and will be deserialized to JSON and returned to the user.
It contains a session_id because the client needs to provide the session ID in the subsequent
questions for tracking the token spend for the given session.</p>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RAGResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that represents the response generated by the model and the session ID.</span>
<span class="sd">    This data class is client facing and will be deserialized to JSON and returned to the user.</span>
<span class="sd">    It contains a session_id because the client needs to provide the session ID in the subsequent</span>
<span class="sd">    questions for tracking the token spend for the given session.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.RemainingSpend" class="doc doc-heading">
            <code>RemainingSpend</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>Class that represents the remaining spend based on the current spend and the maximum spend limit.
This is the object that will later be deserialized to JSON and returned to the user.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>remaining_spend</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The remaining spend based on the current spend and the maximum spend limit.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RemainingSpend</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that represents the remaining spend based on the current spend and the maximum spend limit.</span>
<span class="sd">    This is the object that will later be deserialized to JSON and returned to the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        remaining_spend (float): The remaining spend based on the current spend and the maximum spend limit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">remaining_spend</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration" class="doc doc-heading">
            <code>RetrievalAugmentedGeneration</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>Class that performs retrieval-augmented generation given an input query and k value.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>embedding_service</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.EmbeddingService" href="#backend.retrieval_augmented_generation.retrieve.EmbeddingService">EmbeddingService</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedding service used for text embedding.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>retrieval_service</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievalService" href="#backend.retrieval_augmented_generation.retrieve.RetrievalService">RetrievalService</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The retrieval service used for context retrieval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>generation_service</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.GenerationService" href="#backend.retrieval_augmented_generation.retrieve.GenerationService">GenerationService</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The generation service used for text generation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_spend</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum spend limit for the retrieval-augmented generation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>date</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The date of the retrieval-augmented generation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RetrievalAugmentedGeneration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that performs retrieval-augmented generation given an input query and k value.</span>

<span class="sd">    Args:</span>
<span class="sd">        embedding_service: The embedding service used for text embedding.</span>
<span class="sd">        retrieval_service: The retrieval service used for context retrieval.</span>
<span class="sd">        generation_service: The generation service used for text generation.</span>
<span class="sd">        max_spend: The maximum spend limit for the retrieval-augmented generation.</span>
<span class="sd">        date (datetime.date): The date of the retrieval-augmented generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">embedding_service</span><span class="p">:</span> <span class="s2">&quot;EmbeddingService&quot;</span>
    <span class="n">retrieval_service</span><span class="p">:</span> <span class="s2">&quot;RetrievalService&quot;</span>
    <span class="n">generation_service</span><span class="p">:</span> <span class="s2">&quot;GenerationService&quot;</span>
    <span class="n">max_spend</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">date</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">retrieval_augmented_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;InputQuery&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RAGResponse&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs retrieval-augmented generation given an input query and k value.</span>
<span class="sd">        The method enforces the spend limit, validates the session ID, retrieves the top k contexts,</span>

<span class="sd">        Args:</span>
<span class="sd">            input (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">                the previous context and session ID.</span>
<span class="sd">            k (int): The number of contexts to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (RAGResponse): The response generated by the model and the session ID.</span>

<span class="sd">        Raises:</span>
<span class="sd">            (MaximumSpendError): If the current spend is greater than or equal to the maximum spend limit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_spend_limit</span><span class="p">()</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_assign_session_id</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="n">retrieved</span><span class="p">,</span> <span class="n">tokens_spent</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_top_k</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">store_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">store_token_spent</span><span class="p">(</span>
            <span class="n">session_id</span><span class="p">,</span>
            <span class="n">tokens_spent</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding_service</span><span class="o">.</span><span class="n">get_embed_model_name</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">generation_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_service</span><span class="o">.</span><span class="n">augmented_generation</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">retrieved</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">response_and_tokens</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">store_task</span><span class="p">,</span> <span class="n">generation_task</span><span class="p">)</span>
        <span class="n">response</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">response_and_tokens</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">store_token_spent</span><span class="p">(</span>
            <span class="n">session_id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_service</span><span class="o">.</span><span class="n">get_chat_model_name</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">RAGResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">remaining_spend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RemainingSpend&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Calculates the remaining spend based on the current spend and the maximum spend limit.</span>
<span class="sd">        The spend is capped at 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (RemainingSpend): The remaining spend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_spend</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_spend</span> <span class="o">-</span> <span class="n">current_spend</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RemainingSpend</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_enforce_spend_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Enforces the spend limit by checking the current spend against the maximum spend limit.</span>
<span class="sd">        If the current spend is greater than or equal to the maximum spend limit, raises a `MaximumSpendError`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            (MaximumSpendError): If the current spend is greater than or equal to the maximum spend limit.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_spend</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_spend</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_spend</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaximumSpendError</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_validate_and_assign_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;InputQuery&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Validates the session ID if provided, otherwise generates a new session ID.</span>
<span class="sd">        This method ensures that the session ID is valid and exists in the database.</span>
<span class="sd">        This is necessary to track the token spend for the given session.</span>

<span class="sd">        Args:</span>
<span class="sd">            input (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">                the previous context and session ID.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): The session ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">validate_session_id</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">session_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">session_id</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_retrieve_top_k</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;InputQuery&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;RetrievedContext&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            embeds the input query and retrieves the top k contexts based on the embedded query.</span>


<span class="sd">        Returns:</span>
<span class="sd">            (tuple[list[RetrievedContext], int]): A tuple containing the list of retrieved contexts</span>
<span class="sd">                and the number of tokens spent. see `RetrievedContext` for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_service</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">tokens_spent</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">token_count</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">retrieve_top_k</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">tokens_spent</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration.remaining_spend" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remaining_spend</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the remaining spend based on the current spend and the maximum spend limit.
The spend is capped at 0.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RemainingSpend" href="#backend.retrieval_augmented_generation.retrieve.RemainingSpend">RemainingSpend</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The remaining spend.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">remaining_spend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RemainingSpend&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Calculates the remaining spend based on the current spend and the maximum spend limit.</span>
<span class="sd">    The spend is capped at 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (RemainingSpend): The remaining spend.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_spend</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_spend</span> <span class="o">-</span> <span class="n">current_spend</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">RemainingSpend</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievalAugmentedGeneration.retrieval_augmented_generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">retrieval_augmented_generation</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Performs retrieval-augmented generation given an input query and k value.
The method enforces the spend limit, validates the session ID, retrieves the top k contexts,</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>input</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.InputQuery" href="#backend.retrieval_augmented_generation.retrieve.InputQuery">InputQuery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input query. Contains the user's question, and optionally,
the previous context and session ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>k</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of contexts to retrieve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RAGResponse" href="#backend.retrieval_augmented_generation.retrieve.RAGResponse">RAGResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The response generated by the model and the session ID.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.errors.MaximumSpendError" href="../errors/#backend.errors.MaximumSpendError">MaximumSpendError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the current spend is greater than or equal to the maximum spend limit.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">retrieval_augmented_generation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="s2">&quot;InputQuery&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RAGResponse&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs retrieval-augmented generation given an input query and k value.</span>
<span class="sd">    The method enforces the spend limit, validates the session ID, retrieves the top k contexts,</span>

<span class="sd">    Args:</span>
<span class="sd">        input (InputQuery): The input query. Contains the user&#39;s question, and optionally,</span>
<span class="sd">            the previous context and session ID.</span>
<span class="sd">        k (int): The number of contexts to retrieve.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (RAGResponse): The response generated by the model and the session ID.</span>

<span class="sd">    Raises:</span>
<span class="sd">        (MaximumSpendError): If the current spend is greater than or equal to the maximum spend limit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_spend_limit</span><span class="p">()</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_assign_session_id</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="n">retrieved</span><span class="p">,</span> <span class="n">tokens_spent</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_top_k</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">store_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">store_token_spent</span><span class="p">(</span>
        <span class="n">session_id</span><span class="p">,</span>
        <span class="n">tokens_spent</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_service</span><span class="o">.</span><span class="n">get_embed_model_name</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">generation_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_service</span><span class="o">.</span><span class="n">augmented_generation</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">retrieved</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">response_and_tokens</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">store_task</span><span class="p">,</span> <span class="n">generation_task</span><span class="p">)</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">response_and_tokens</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_service</span><span class="o">.</span><span class="n">store_token_spent</span><span class="p">(</span>
        <span class="n">session_id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_service</span><span class="o">.</span><span class="n">get_chat_model_name</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">RAGResponse</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.RetrievalService" class="doc doc-heading">
            <code>RetrievalService</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-external" title="typing.Protocol" href="https://docs.python.org/3/library/typing.html#typing.Protocol">Protocol</a></code></p>


        <p>Interface for the retrieval service. Responsible for retrieving the top k
contexts based on the embedded query. The query is embedded already by the
<code>EmbeddingService</code>.</p>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RetrievalService</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface for the retrieval service. Responsible for retrieving the top k</span>
<span class="sd">    contexts based on the embedded query. The query is embedded already by the</span>
<span class="sd">    `EmbeddingService`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_top_k</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embedded_query</span><span class="p">:</span> <span class="s2">&quot;EmbeddedResponse&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;RetrievedContext&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Retrieves the top k contexts based on the embedded query.</span>
<span class="sd">        The contexts are the k most relevant documents to the embedded query.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedded_query (EmbeddedResponse): The embedded query.</span>
<span class="sd">            k (int): The number of contexts to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list[RetrievedContext]): The list of retrieved contexts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">store_token_spent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Stores the token count spent for a given session ID and model name.</span>
<span class="sd">        This is necessary to track the token spend for the given session. This</span>
<span class="sd">        is used further down the line to calculate the current spend and enforce</span>
<span class="sd">        the spend limit.</span>

<span class="sd">        Args:</span>
<span class="sd">            session_id (str): The session ID.</span>
<span class="sd">            token_count (int): The number of tokens spent.</span>
<span class="sd">            model_name (str): The name of the model used for token count. Different</span>
<span class="sd">                models have different token costs. Embedding models are</span>
<span class="sd">                typically cheaper than generation models.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="o">...</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Validates the session ID if provided. This method ensures that the session ID is valid</span>
<span class="sd">        and exists in the database. This is necessary to track the token spend for the given session.</span>

<span class="sd">        Args:</span>
<span class="sd">            session_id (str): The session ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Retrieves the current spend for a given date. The date is</span>
<span class="sd">        mostly given as a parameter to facilitate testing, it keeps</span>
<span class="sd">        this method more pure than it is if it had to instantiate the date.</span>

<span class="sd">        Args:</span>
<span class="sd">            date (date): The date for which to retrieve the current spend.</span>


<span class="sd">        Returns:</span>
<span class="sd">            (float): The current spend for the given date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievalService.get_current_spend" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_current_spend</span><span class="p">(</span><span class="n">date</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the current spend for a given date. The date is
mostly given as a parameter to facilitate testing, it keeps
this method more pure than it is if it had to instantiate the date.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>date</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The date for which to retrieve the current spend.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current spend for the given date.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Retrieves the current spend for a given date. The date is</span>
<span class="sd">    mostly given as a parameter to facilitate testing, it keeps</span>
<span class="sd">    this method more pure than it is if it had to instantiate the date.</span>

<span class="sd">    Args:</span>
<span class="sd">        date (date): The date for which to retrieve the current spend.</span>


<span class="sd">    Returns:</span>
<span class="sd">        (float): The current spend for the given date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievalService.retrieve_top_k" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">retrieve_top_k</span><span class="p">(</span><span class="n">embedded_query</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the top k contexts based on the embedded query.
The contexts are the k most relevant documents to the embedded query.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>embedded_query</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" href="#backend.retrieval_augmented_generation.retrieve.EmbeddedResponse">EmbeddedResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedded query.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>k</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of contexts to retrieve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievedContext" href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext">RetrievedContext</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of retrieved contexts.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_top_k</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">embedded_query</span><span class="p">:</span> <span class="s2">&quot;EmbeddedResponse&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;RetrievedContext&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Retrieves the top k contexts based on the embedded query.</span>
<span class="sd">    The contexts are the k most relevant documents to the embedded query.</span>

<span class="sd">    Args:</span>
<span class="sd">        embedded_query (EmbeddedResponse): The embedded query.</span>
<span class="sd">        k (int): The number of contexts to retrieve.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list[RetrievedContext]): The list of retrieved contexts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievalService.store_token_spent" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store_token_spent</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">token_count</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Stores the token count spent for a given session ID and model name.
This is necessary to track the token spend for the given session. This
is used further down the line to calculate the current spend and enforce
the spend limit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session_id</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>token_count</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of tokens spent.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>model_name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model used for token count. Different
models have different token costs. Embedding models are
typically cheaper than generation models.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">store_token_spent</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Stores the token count spent for a given session ID and model name.</span>
<span class="sd">    This is necessary to track the token spend for the given session. This</span>
<span class="sd">    is used further down the line to calculate the current spend and enforce</span>
<span class="sd">    the spend limit.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_id (str): The session ID.</span>
<span class="sd">        token_count (int): The number of tokens spent.</span>
<span class="sd">        model_name (str): The name of the model used for token count. Different</span>
<span class="sd">            models have different token costs. Embedding models are</span>
<span class="sd">            typically cheaper than generation models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievalService.validate_session_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_session_id</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Validates the session ID if provided. This method ensures that the session ID is valid
and exists in the database. This is necessary to track the token spend for the given session.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session_id</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session ID.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">validate_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Validates the session ID if provided. This method ensures that the session ID is valid</span>
<span class="sd">    and exists in the database. This is necessary to track the token spend for the given session.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_id (str): The session ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.RetrievedContext" class="doc doc-heading">
            <code>RetrievedContext</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>This is a domain class and is used to represent the context retrieved from the database. Its
main purpose is to provide a structured representation of the context that is retrieved from the
database. This simplifies testing, all of the logic relies on domain objects rather than database
specific types.</p>
<p>The class also provides helpers to enrich the file content with additional information such as
the file name, repository name, path in the repository, and file extension. This is useful for
generating the response to the user.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>distance</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The distance between the embedded query and the retrieved context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>file_name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>repository_name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the repository.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>path_in_repo</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path of the file in the repository.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>extension</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file extension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>url</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The URL to the file content.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RetrievedContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a domain class and is used to represent the context retrieved from the database. Its</span>
<span class="sd">    main purpose is to provide a structured representation of the context that is retrieved from the</span>
<span class="sd">    database. This simplifies testing, all of the logic relies on domain objects rather than database</span>
<span class="sd">    specific types.</span>

<span class="sd">    The class also provides helpers to enrich the file content with additional information such as</span>
<span class="sd">    the file name, repository name, path in the repository, and file extension. This is useful for</span>
<span class="sd">    generating the response to the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        distance (float): The distance between the embedded query and the retrieved context.</span>
<span class="sd">        file_name (str): The name of the file.</span>
<span class="sd">        repository_name (str): The name of the repository.</span>
<span class="sd">        path_in_repo (str): The path of the file in the repository.</span>
<span class="sd">        extension (str): The file extension.</span>
<span class="sd">        url (str): The URL to the file content.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">repository_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path_in_repo</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_document</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="n">GithubFileModel</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RetrievedContext&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a `RetrievedContext` object from the document retrieved from the database.</span>


<span class="sd">        Args:</span>
<span class="sd">            score (float): The distance between the embedded query and the retrieved context.</span>
<span class="sd">            document (GithubFileModel): The document retrieved from the database.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (RetrievedContext): The retrieved context object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">repository_name</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">repository_name</span><span class="p">,</span>
            <span class="n">path_in_repo</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">path_in_repo</span><span class="p">,</span>
            <span class="n">extension</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">file_extension</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">content_url</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">to_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the file content from the URL and enriches it with additional information such as</span>
<span class="sd">        the file name, repository name, path in the repository, and file extension. This may</span>
<span class="sd">        improve generation quality by providing additional context to the model. The method is asynchronous</span>
<span class="sd">        because it fetches the file content from the URL. The data isn&#39;t persisted as such, it is fetched</span>
<span class="sd">        on-demand when needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): The file content enriched with additional information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
                    <span class="n">file_content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enrich_file_content</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_enrich_file_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enriches the file content with additional information such as the file name, repository name,</span>
<span class="sd">        path in the repository, and file extension. This may improve generation quality by providing</span>
<span class="sd">        additional context to the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_content (str): The file content.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str): The file content enriched with additional information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The file name is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">file_place_in_project</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The file is located at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path_in_repo</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">file_extension</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The file extension is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">file_content</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="n">file_place_in_project</span> <span class="o">+</span> <span class="n">file_extension</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievedContext.from_document" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_document</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Creates a <code>RetrievedContext</code> object from the document retrieved from the database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>score</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The distance between the embedded query and the retrieved context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>document</code></td>
            <td>
                  <code><span title="shared.database.GithubFileModel">GithubFileModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The document retrieved from the database.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievedContext" href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext">RetrievedContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The retrieved context object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_document</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="n">GithubFileModel</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RetrievedContext&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a `RetrievedContext` object from the document retrieved from the database.</span>


<span class="sd">    Args:</span>
<span class="sd">        score (float): The distance between the embedded query and the retrieved context.</span>
<span class="sd">        document (GithubFileModel): The document retrieved from the database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (RetrievedContext): The retrieved context object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
        <span class="n">file_name</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">repository_name</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">repository_name</span><span class="p">,</span>
        <span class="n">path_in_repo</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">path_in_repo</span><span class="p">,</span>
        <span class="n">extension</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">file_extension</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">content_url</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.RetrievedContext.to_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_context</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the file content from the URL and enriches it with additional information such as
the file name, repository name, path in the repository, and file extension. This may
improve generation quality by providing additional context to the model. The method is asynchronous
because it fetches the file content from the URL. The data isn't persisted as such, it is fetched
on-demand when needed.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file content enriched with additional information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">to_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the file content from the URL and enriches it with additional information such as</span>
<span class="sd">    the file name, repository name, path in the repository, and file extension. This may</span>
<span class="sd">    improve generation quality by providing additional context to the model. The method is asynchronous</span>
<span class="sd">    because it fetches the file content from the URL. The data isn&#39;t persisted as such, it is fetched</span>
<span class="sd">    on-demand when needed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): The file content enriched with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
                <span class="n">file_content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enrich_file_content</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="backend.retrieval_augmented_generation.retrieve.SQLRetrievalService" class="doc doc-heading">
            <code>SQLRetrievalService</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievalService" href="#backend.retrieval_augmented_generation.retrieve.RetrievalService">RetrievalService</a></code></p>


        <p>A class that performs context retrieval using SQL. The class is responsible for retrieving the top k
contexts based on the embedded query. The query is embedded already by the <code>EmbeddingService</code>. The class
is a wrapper around SQLAlchemy and provides a more testable and maintainable interface. It implements
the <code>RetrievalService</code> interface.</p>
<p>Aside from this it is also responsible for storing the token spend and validating the session ID.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.errors.InputError" href="../errors/#backend.errors.InputError">InputError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a Session ID is provided, it must already exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SQLRetrievalService</span><span class="p">(</span><span class="n">RetrievalService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that performs context retrieval using SQL. The class is responsible for retrieving the top k</span>
<span class="sd">    contexts based on the embedded query. The query is embedded already by the `EmbeddingService`. The class</span>
<span class="sd">    is a wrapper around SQLAlchemy and provides a more testable and maintainable interface. It implements</span>
<span class="sd">    the `RetrievalService` interface.</span>

<span class="sd">    Aside from this it is also responsible for storing the token spend and validating the session ID.</span>

<span class="sd">    Raises:</span>
<span class="sd">        (InputError): If a Session ID is provided, it must already exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">async_session</span><span class="p">:</span> <span class="n">AsyncSession</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_top_k</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embedded_query</span><span class="p">:</span> <span class="n">EmbeddedResponse</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RetrievedContext</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the top k contexts based on the embedded query. The contexts are the k most relevant</span>
<span class="sd">        documents to the embedded query. The distance between the embedded query and the retrieved context</span>
<span class="sd">        is given by the cosine distance.</span>

<span class="sd">        In short, the lower the distance, the more similar the context is to the query.</span>
<span class="sd">        This is why we order by distance and limit the number of contexts to k.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedded_query (EmbeddedResponse): The embedded query. This is done by the `EmbeddingService`.</span>
<span class="sd">            k (int): The number of contexts to retrieve.</span>
<span class="sd">                Can be set with the `TOP_K` environment variable. The default value is 5 but it is configurable.</span>
<span class="sd">                Increasing it will also increase the token spend.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list[RetrievedContext]): The list of retrieved contexts.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span>
                <span class="n">EmbeddedDocumentModel</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">cosine_distance</span><span class="p">(</span>
                    <span class="n">embedded_query</span><span class="o">.</span><span class="n">embedding</span>
                <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">),</span>
                <span class="n">EmbeddedDocumentModel</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">GithubFileModel</span><span class="p">,</span> <span class="n">EmbeddedDocumentModel</span><span class="o">.</span><span class="n">document_id</span> <span class="o">==</span> <span class="n">GithubFileModel</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="n">documents</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">RetrievedContext</span><span class="o">.</span><span class="n">from_document</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">document</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span>
        <span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">store_token_spent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In multiple steps of the RAG pipeline, we need to store the token count spent for a given session ID</span>
<span class="sd">        and model name. This is necessary to track the token spend for the given session. This is used further</span>
<span class="sd">        down the line to calculate the current spend and enforce the spend limit.</span>

<span class="sd">        The moments where we need to store the token count spent are:</span>
<span class="sd">        - After the embedding step.</span>
<span class="sd">        - After the generation step.</span>

<span class="sd">        The moments this is done may also increase as the RAG is further developed.</span>


<span class="sd">        Args:</span>
<span class="sd">            session_id (str): The session ID. Corresponds to a single conversation.</span>
<span class="sd">            token_count (int): The number of tokens spent.</span>
<span class="sd">            model_name (str): The name of the model used. Different models have different token costs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token_spend</span> <span class="o">=</span> <span class="n">TokenSpendModel</span><span class="p">(</span>
            <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">token_count</span><span class="o">=</span><span class="n">token_count</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token_spend</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the current spend for a given date. The date is mostly given as a parameter to facilitate</span>
<span class="sd">        testing, it keeps this method more pure than it is if it had to instantiate the date.</span>

<span class="sd">        The current spend is given as follows:</span>
<span class="sd">        - The token count spent for the given date is retrieved.</span>
<span class="sd">        - The token count spent is multiplied by 0.00001 to get the spend in dollars.</span>
<span class="sd">        - The sum of all the spends is returned.</span>

<span class="sd">        0.00001 is taken as a constant, it&#39;s the approximate cost, taking into account both model costs. It&#39;s a</span>
<span class="sd">        conservative estimate, the actual cost may be lower.</span>


<span class="sd">        Args:</span>
<span class="sd">            date (datetime.date): The date for which to retrieve the current spend.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (float): The current spend for the given date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">Date</span><span class="p">)</span> <span class="o">==</span> <span class="n">date</span>
        <span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">token_count</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()])</span> <span class="o">*</span> <span class="mf">0.00001</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">validate_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the session ID if provided. This method ensures that the session ID is valid</span>
<span class="sd">        and exists in the database. This is necessary to track the token spend for the given session.</span>

<span class="sd">        Args:</span>
<span class="sd">            session_id (str): The unique id of the conversation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            (InputError): If a Session ID is provided, it must already exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;If a Session ID is provided, it must already exist.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.get_current_spend" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_current_spend</span><span class="p">(</span><span class="n">date</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the current spend for a given date. The date is mostly given as a parameter to facilitate
testing, it keeps this method more pure than it is if it had to instantiate the date.</p>
<p>The current spend is given as follows:
- The token count spent for the given date is retrieved.
- The token count spent is multiplied by 0.00001 to get the spend in dollars.
- The sum of all the spends is returned.</p>
<p>0.00001 is taken as a constant, it's the approximate cost, taking into account both model costs. It's a
conservative estimate, the actual cost may be lower.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>date</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" title="datetime.date" href="https://docs.python.org/3/library/datetime.html#datetime.date">date</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The date for which to retrieve the current spend.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#float">float</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current spend for the given date.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_current_spend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the current spend for a given date. The date is mostly given as a parameter to facilitate</span>
<span class="sd">    testing, it keeps this method more pure than it is if it had to instantiate the date.</span>

<span class="sd">    The current spend is given as follows:</span>
<span class="sd">    - The token count spent for the given date is retrieved.</span>
<span class="sd">    - The token count spent is multiplied by 0.00001 to get the spend in dollars.</span>
<span class="sd">    - The sum of all the spends is returned.</span>

<span class="sd">    0.00001 is taken as a constant, it&#39;s the approximate cost, taking into account both model costs. It&#39;s a</span>
<span class="sd">    conservative estimate, the actual cost may be lower.</span>


<span class="sd">    Args:</span>
<span class="sd">        date (datetime.date): The date for which to retrieve the current spend.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): The current spend for the given date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">cast</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">Date</span><span class="p">)</span> <span class="o">==</span> <span class="n">date</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">token_count</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()])</span> <span class="o">*</span> <span class="mf">0.00001</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.retrieve_top_k" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">retrieve_top_k</span><span class="p">(</span><span class="n">embedded_query</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Retrieves the top k contexts based on the embedded query. The contexts are the k most relevant
documents to the embedded query. The distance between the embedded query and the retrieved context
is given by the cosine distance.</p>
<p>In short, the lower the distance, the more similar the context is to the query.
This is why we order by distance and limit the number of contexts to k.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>embedded_query</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.EmbeddedResponse" href="#backend.retrieval_augmented_generation.retrieve.EmbeddedResponse">EmbeddedResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedded query. This is done by the <code>EmbeddingService</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>k</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of contexts to retrieve.
Can be set with the <code>TOP_K</code> environment variable. The default value is 5 but it is configurable.
Increasing it will also increase the token spend.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-internal" title="backend.retrieval_augmented_generation.retrieve.RetrievedContext" href="#backend.retrieval_augmented_generation.retrieve.RetrievedContext">RetrievedContext</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of retrieved contexts.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve_top_k</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">embedded_query</span><span class="p">:</span> <span class="n">EmbeddedResponse</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RetrievedContext</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the top k contexts based on the embedded query. The contexts are the k most relevant</span>
<span class="sd">    documents to the embedded query. The distance between the embedded query and the retrieved context</span>
<span class="sd">    is given by the cosine distance.</span>

<span class="sd">    In short, the lower the distance, the more similar the context is to the query.</span>
<span class="sd">    This is why we order by distance and limit the number of contexts to k.</span>

<span class="sd">    Args:</span>
<span class="sd">        embedded_query (EmbeddedResponse): The embedded query. This is done by the `EmbeddingService`.</span>
<span class="sd">        k (int): The number of contexts to retrieve.</span>
<span class="sd">            Can be set with the `TOP_K` environment variable. The default value is 5 but it is configurable.</span>
<span class="sd">            Increasing it will also increase the token spend.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list[RetrievedContext]): The list of retrieved contexts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">(</span>
            <span class="n">EmbeddedDocumentModel</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">cosine_distance</span><span class="p">(</span>
                <span class="n">embedded_query</span><span class="o">.</span><span class="n">embedding</span>
            <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">),</span>
            <span class="n">EmbeddedDocumentModel</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GithubFileModel</span><span class="p">,</span> <span class="n">EmbeddedDocumentModel</span><span class="o">.</span><span class="n">document_id</span> <span class="o">==</span> <span class="n">GithubFileModel</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">RetrievedContext</span><span class="o">.</span><span class="n">from_document</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">document</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.store_token_spent" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store_token_spent</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">token_count</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>In multiple steps of the RAG pipeline, we need to store the token count spent for a given session ID
and model name. This is necessary to track the token spend for the given session. This is used further
down the line to calculate the current spend and enforce the spend limit.</p>
<p>The moments where we need to store the token count spent are:
- After the embedding step.
- After the generation step.</p>
<p>The moments this is done may also increase as the RAG is further developed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session_id</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session ID. Corresponds to a single conversation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>token_count</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/functions.html#int">int</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of tokens spent.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>model_name</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model used. Different models have different token costs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">store_token_spent</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In multiple steps of the RAG pipeline, we need to store the token count spent for a given session ID</span>
<span class="sd">    and model name. This is necessary to track the token spend for the given session. This is used further</span>
<span class="sd">    down the line to calculate the current spend and enforce the spend limit.</span>

<span class="sd">    The moments where we need to store the token count spent are:</span>
<span class="sd">    - After the embedding step.</span>
<span class="sd">    - After the generation step.</span>

<span class="sd">    The moments this is done may also increase as the RAG is further developed.</span>


<span class="sd">    Args:</span>
<span class="sd">        session_id (str): The session ID. Corresponds to a single conversation.</span>
<span class="sd">        token_count (int): The number of tokens spent.</span>
<span class="sd">        model_name (str): The name of the model used. Different models have different token costs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">token_spend</span> <span class="o">=</span> <span class="n">TokenSpendModel</span><span class="p">(</span>
        <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
        <span class="n">token_count</span><span class="o">=</span><span class="n">token_count</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token_spend</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="backend.retrieval_augmented_generation.retrieve.SQLRetrievalService.validate_session_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_session_id</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Validates the session ID if provided. This method ensures that the session ID is valid
and exists in the database. This is necessary to track the token spend for the given session.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session_id</code></td>
            <td>
                  <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#str">str</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unique id of the conversation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="backend.errors.InputError" href="../errors/#backend.errors.InputError">InputError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a Session ID is provided, it must already exist.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">validate_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates the session ID if provided. This method ensures that the session ID is valid</span>
<span class="sd">    and exists in the database. This is necessary to track the token spend for the given session.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_id (str): The unique id of the conversation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        (InputError): If a Session ID is provided, it must already exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TokenSpendModel</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="n">session_id</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">map_errors</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;If a Session ID is provided, it must already exist.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="backend.retrieval_augmented_generation.retrieve.add_sources" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_sources</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">retrieved</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Adds the sources to the answer. The sources are the list of retrieved contexts.
The sources are added as an HTML section at the end of the answer.
Args:
    answer (str): The answer generated by the model.
    retrieved (list[RetrievedContext]): The list of retrieved contexts.
Returns:
    (str): The answer with the sources added as an HTML section at the end.</p>

            <details class="quote">
              <summary>Source code in <code>backend/backend/retrieval_augmented_generation/retrieve.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_sources</span><span class="p">(</span><span class="n">answer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retrieved</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RetrievedContext</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the sources to the answer. The sources are the list of retrieved contexts.</span>
<span class="sd">    The sources are added as an HTML section at the end of the answer.</span>
<span class="sd">    Args:</span>
<span class="sd">        answer (str): The answer generated by the model.</span>
<span class="sd">        retrieved (list[RetrievedContext]): The list of retrieved contexts.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (str): The answer with the sources added as an HTML section at the end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;li&gt;</span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">repository_name</span><span class="p">)</span><span class="si">}</span><span class="s2">, &lt;a href=</span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;source.&lt;/a&gt;&lt;/li&gt;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">retrieved</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="se">\n</span><span class="s2"> &lt;section id=&quot;sources&quot;&gt;To answer this question, I used the following sources:</span>
<span class="s2">        &lt;ul&gt;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/ul&gt;&lt;/section&gt;&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>